services:
  proxy:
    build:
      context: .
      dockerfile: docker/Dockerfile
    environment:
      PROXY_PORT: ${PROXY_PORT:-5000}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      OPENROUTER_URL: ${OPENROUTER_URL:-}
      ALLOW_SERVER_API_KEY: ${ALLOW_SERVER_API_KEY:-false}
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-*}"
      RATE_LIMIT: ${RATE_LIMIT:-}
      CONNECT_TIMEOUT: ${CONNECT_TIMEOUT:-}
      READ_TIMEOUT: ${READ_TIMEOUT:-}
      LOG_DIR: ${LOG_DIR:-var/logs}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      MAX_LOG_FILES: ${MAX_LOG_FILES:-1000}
    ports:
      - "${PROXY_PORT:-5000}:${PROXY_PORT:-5000}"
    volumes:
      - ./app/var:/workspace/app/var
    restart: unless-stopped

  tunnel:
    build:
      context: .
      dockerfile: docker/tunnel/Dockerfile
    depends_on:
      proxy:
        condition: service_healthy
    environment:
      PROXY_PORT: ${PROXY_PORT:-5000}
      CLOUDFLARED_FLAGS: ${CLOUDFLARED_FLAGS:-}
      TARGET_HOST: proxy
      STATE_DIR: /workspace/app/var/state
      TUNNEL_URL_FILE: /workspace/app/var/state/tunnel_url.txt
    volumes:
      - ./app/var:/workspace/app/var
    restart: unless-stopped

