# Cloudflare Workers 迁移方案

## 项目概述

将 Scrapitor 从 Python Flask 应用迁移到 Cloudflare Workers + Pages，并添加 SillyTavern 角色卡生成功能。

## 当前架构分析

### 后端 (Flask)
- **API 代理**: 转发请求到 OpenRouter
- **日志存储**: 保存请求到 `var/logs/*.json`
- **Parser**: Python subprocess 调用解析脚本
- **文件管理**: 读取/重命名/删除日志和解析文件

### 前端 (Vanilla JS)
- **单页应用**: 1600+ 行纯 JavaScript
- **功能**: 日志列表、Parser 配置、文件查看
- **依赖**: 无外部框架

### Parser 逻辑 (parser.py)
- **标签解析**: 提取 XML 风格标签内容
- **过滤系统**: Include/Exclude 模式
- **输出**: TXT 文件

## 迁移策略

### 方案: 无服务器架构 (推荐)

**技术栈:**
- Cloudflare Workers: API 处理
- Cloudflare Pages: 静态前端托管
- 浏览器端处理: 所有文件操作

**优点:**
- ✅ 完全无服务器
- ✅ 全球 CDN 加速
- ✅ 零成本（免费额度内）
- ✅ 无需持久化存储

**限制:**
- ❌ 无历史记录（实时处理）
- ❌ 需要重写 Parser

## 详细实现计划

### 阶段 1: Workers API (核心功能)

#### 文件: `workers/src/index.ts`

```typescript
export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const url = new URL(request.url);

    if (url.pathname === '/api/proxy') {
      return handleProxy(request, env);
    }

    if (url.pathname === '/api/parse') {
      return handleParse(request);
    }

    if (url.pathname === '/api/create-card') {
      return handleCreateCard(request);
    }

    return new Response('Not Found', { status: 404 });
  }
};
```

**功能模块:**

1. **API 代理** (`/api/proxy`)
   - 转发到 OpenRouter
   - 支持流式响应
   - CORS 处理

2. **解析服务** (`/api/parse`)
   - 接收 OpenRouter 响应
   - 应用 Parser 规则
   - 返回解析后的文本

3. **角色卡生成** (`/api/create-card`)
   - 转换为 Character Card V2 格式
   - Base64 编码
   - 返回 JSON（前端处理 PNG）

### 阶段 2: TypeScript Parser

#### 文件: `workers/src/parser.ts`

```typescript
export interface ParserConfig {
  mode: 'default' | 'custom';
  includeTags: string[];
  excludeTags: string[];
}

export interface ParsedResult {
  characterName: string;
  content: string;
  tags: string[];
}

export class MessageParser {
  private config: ParserConfig;

  constructor(config: ParserConfig) {
    this.config = config;
  }

  parse(messages: any[]): ParsedResult {
    // 重写 parser.py 的逻辑
  }

  private extractTags(content: string): string[] {
    // 标签提取逻辑
  }

  private filterContent(content: string): string {
    // 过滤逻辑
  }
}
```

**核心算法迁移:**
- `_find_first_non_skipped_tag` → `findFirstTag()`
- `_extract_tag_content` → `extractTagContent()`
- `_remove_tag_blocks` → `removeTagBlocks()`
- `process_json` → `parse()`

### 阶段 3: 角色卡生成 (前端)

#### 文件: `public/js/character-card.js`

```javascript
class CharacterCardGenerator {
  /**
   * 将解析后的文本转换为 Character Card V2 格式
   */
  static createCardData(parsedText, metadata = {}) {
    return {
      spec: 'chara_card_v2',
      spec_version: '2.0',
      data: {
        name: metadata.name || 'Character',
        description: parsedText,
        personality: '',
        scenario: metadata.scenario || '',
        first_mes: metadata.firstMessage || '',
        mes_example: '',
        creator_notes: 'Generated by Scrapitor',
        system_prompt: '',
        post_history_instructions: '',
        alternate_greetings: [],
        character_book: null,
        tags: [],
        creator: 'Scrapitor',
        character_version: '1.0',
        extensions: {}
      }
    };
  }

  /**
   * 将 JSON 嵌入 PNG 图片
   */
  static async embedIntoPNG(imageFile, cardData) {
    // 使用 PNG.js 或原生 Canvas API
    const base64Data = btoa(JSON.stringify(cardData));
    // ... PNG tEXt chunk 处理
  }
}
```

#### 文件: `public/js/png-handler.js`

```javascript
/**
 * PNG 元数据处理（纯浏览器端）
 */
class PNGHandler {
  static async addTextChunk(imageBlob, keyword, text) {
    const arrayBuffer = await imageBlob.arrayBuffer();
    const chunks = this.parseChunks(arrayBuffer);

    // 添加 tEXt chunk
    const textChunk = this.createTextChunk(keyword, text);
    chunks.splice(-1, 0, textChunk); // 插入到 IEND 前

    return this.assembleChunks(chunks);
  }

  static createTextChunk(keyword, text) {
    // PNG tEXt chunk 规范实现
    // Keyword: "chara"
    // Text: base64 encoded JSON
  }

  static parseChunks(buffer) {
    // PNG chunk 解析
  }

  static assembleChunks(chunks) {
    // 重新组装 PNG
  }
}
```

### 阶段 4: 前端 UI 更新

#### 新增功能界面

**角色卡导出面板:**

```html
<section id="character-card" class="section">
  <h2>Character Card Generator</h2>

  <div class="card-workflow">
    <!-- 步骤 1: 解析配置 -->
    <div class="workflow-step">
      <h3>1. Configure Parser</h3>
      <p>Select tags to include in character card</p>
      <!-- 使用现有的 Parser UI -->
    </div>

    <!-- 步骤 2: 选择日志 -->
    <div class="workflow-step">
      <h3>2. Select Log</h3>
      <select id="logSelector">
        <!-- 动态填充 -->
      </select>
      <button onclick="parseForCard()">Parse</button>
    </div>

    <!-- 步骤 3: 预览结果 -->
    <div class="workflow-step">
      <h3>3. Preview</h3>
      <textarea id="cardPreview" rows="10"></textarea>
    </div>

    <!-- 步骤 4: 上传图片 -->
    <div class="workflow-step">
      <h3>4. Upload Character Image</h3>
      <input type="file" id="imageUpload" accept="image/png">
      <div id="imagePreview"></div>
    </div>

    <!-- 步骤 5: 生成并下载 -->
    <div class="workflow-step">
      <h3>5. Generate Card</h3>
      <button onclick="generateCard()" class="button-primary">
        Generate & Download
      </button>
    </div>
  </div>
</section>
```

**JavaScript 集成:**

```javascript
async function generateCard() {
  const parsedText = document.getElementById('cardPreview').value;
  const imageFile = document.getElementById('imageUpload').files[0];

  if (!imageFile) {
    notifications.show('Please upload an image', 'error');
    return;
  }

  // 1. 创建 Card Data
  const cardData = CharacterCardGenerator.createCardData(parsedText, {
    name: extractCharacterName(parsedText),
    scenario: extractScenario(parsedText),
    firstMessage: extractFirstMessage(parsedText)
  });

  // 2. 嵌入 PNG
  const cardImage = await PNGHandler.addTextChunk(
    imageFile,
    'chara',
    btoa(JSON.stringify(cardData))
  );

  // 3. 触发下载
  downloadFile(cardImage, `${cardData.data.name}.png`);

  notifications.show('Character card generated!', 'success');
}
```

### 阶段 5: 部署配置

#### 文件: `wrangler.toml`

```toml
name = "scrapitor-api"
main = "src/index.ts"
compatibility_date = "2024-01-01"

[env.production]
vars = { ENVIRONMENT = "production" }

[[env.production.routes]]
pattern = "scrapitor.yourdomain.com/api/*"

[build]
command = "npm run build"
```

#### 文件: `.github/workflows/deploy.yml`

```yaml
name: Deploy to Cloudflare

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm install
      - run: npm run build
      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
```

## 项目结构

```
Scrapitor/
├── workers/                    # Cloudflare Workers
│   ├── src/
│   │   ├── index.ts           # 主入口
│   │   ├── parser.ts          # Parser 逻辑
│   │   ├── proxy.ts           # API 代理
│   │   └── character-card.ts  # 角色卡生成
│   ├── package.json
│   └── wrangler.toml
│
├── public/                     # Cloudflare Pages
│   ├── index.html
│   ├── js/
│   │   ├── app.js             # 主应用 (精简版)
│   │   ├── character-card.js  # 角色卡生成器
│   │   └── png-handler.js     # PNG 处理
│   ├── css/
│   │   └── app.css
│   └── assets/
│
├── docs/
│   ├── cloudflare-workers-migration-plan.md
│   └── character-card-spec.md
│
└── legacy/                     # 原 Python 代码（参考）
    └── app/

```

## 功能对比

| 功能 | 原版 (Flask) | Workers 版本 | 状态 |
|------|-------------|-------------|------|
| API 代理 | ✅ | ✅ | 完全支持 |
| 实时解析 | ✅ | ✅ | 完全支持 |
| 历史记录列表 | ✅ | ❌ | 不支持 |
| 标签过滤 | ✅ | ✅ | 完全支持 |
| 文件下载 | ✅ | ✅ | 完全支持 |
| 角色卡生成 | ❌ | ✅ | 新功能 |
| PNG 元数据 | ❌ | ✅ | 新功能 |

## 工作量估算

| 任务 | 难度 | 时间 | 优先级 |
|------|------|------|--------|
| Workers API 骨架 | 简单 | 2h | P0 |
| Parser TypeScript 迁移 | 中等 | 8h | P0 |
| 代理功能实现 | 简单 | 3h | P0 |
| Character Card V2 实现 | 中等 | 4h | P1 |
| PNG 处理库 | 复杂 | 6h | P1 |
| 前端 UI 更新 | 中等 | 4h | P1 |
| 测试和调试 | 中等 | 4h | P2 |
| 文档编写 | 简单 | 2h | P2 |

**总计: 约 33 小时 (2-3 个工作日)**

## 开发路线图

### Week 1: 核心迁移
- [x] 项目结构搭建
- [ ] TypeScript Parser 实现
- [ ] Workers API 骨架
- [ ] 代理功能测试

### Week 2: 角色卡功能
- [ ] Character Card V2 数据结构
- [ ] PNG 元数据处理
- [ ] 前端集成
- [ ] E2E 测试

### Week 3: 优化和部署
- [ ] 性能优化
- [ ] 错误处理
- [ ] 文档完善
- [ ] 生产部署

## 风险和挑战

### 技术风险

1. **PNG 处理复杂度**
   - 风险: 浏览器端 PNG chunk 操作可能不稳定
   - 缓解: 使用成熟库如 `pngjs` 或 `upng-js`

2. **Parser 逻辑复杂性**
   - 风险: Python → TypeScript 迁移可能遗漏边界情况
   - 缓解: 编写完整单元测试

3. **Workers 限制**
   - 风险: CPU 时间 / 内存限制
   - 缓解: 将大文件处理移到前端

### 用户体验风险

1. **无历史记录**
   - 影响: 用户无法查看过往日志
   - 缓解: 提供"下载 JSON"选项，本地保存

2. **浏览器兼容性**
   - 影响: 旧浏览器可能不支持
   - 缓解: 添加兼容性检测和提示

## 成功标准

- [x] API 代理正常工作
- [ ] Parser 输出与原版一致
- [ ] 生成的角色卡能被 SillyTavern 识别
- [ ] 页面加载时间 < 2s
- [ ] 所有功能在 Chrome/Firefox/Safari 正常运行

## 下一步行动

1. **立即开始**: 创建 Workers 项目结构
2. **并行开发**: Parser TypeScript 迁移
3. **快速验证**: 最小可用产品 (MVP) 测试
4. **迭代优化**: 根据测试结果调整

---

**文档版本**: 1.0
**最后更新**: 2025-11-30
**作者**: Claude Code
